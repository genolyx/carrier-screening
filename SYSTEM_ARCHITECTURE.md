# Dark Gene Pipeline - ì „ì²´ ì‹œìŠ¤í…œ êµ¬ì¡°

## ğŸ—ï¸ ì•„í‚¤í…ì²˜ ê°œìš”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Portal                              â”‚
â”‚                  (portal.genolyx.com)                       â”‚
â”‚  - Analysis Summary Dashboard (ì²¨ë¶€ ì´ë¯¸ì§€ì™€ ê°™ì€ UI)        â”‚
â”‚  - ê²°ê³¼ íŒŒì¼ ì¡°íšŒ ë° ë‹¤ìš´ë¡œë“œ                                â”‚
â”‚  - ì‚¬ìš©ì ê´€ë¦¬                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ REST API
                  â”‚ - ìƒíƒœ ì¡°íšŒ
                  â”‚ - íŒŒì¼ ì—…ë¡œë“œ
                  â”‚ - ì§„í–‰ë¥  ë³´ê³ 
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Portal Daemon (Docker Container)               â”‚
â”‚  - ë¶„ì„ ì™„ë£Œ ê°ì§€ (File System Watcher)                      â”‚
â”‚  - ìë™ ê²°ê³¼ ì—…ë¡œë“œ                                          â”‚
â”‚  - ì‹¤ì‹œê°„ ìƒíƒœ ëª¨ë‹ˆí„°ë§                                      â”‚
â”‚  - API Server (localhost:8080)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ File System Access (Read-only)
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Dark Gene Pipeline (Host System)                 â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚            Dashboard (Flask App)                     â”‚   â”‚
â”‚  â”‚  - ìƒ˜í”Œ ì„ íƒ ë° ë¶„ì„ ì‹œì‘                             â”‚   â”‚
â”‚  â”‚  - ì‹¤ì‹œê°„ ì§„í–‰ ëª¨ë‹ˆí„°ë§                               â”‚   â”‚
â”‚  â”‚  - ë¡œì»¬ ê²°ê³¼ í™•ì¸                                    â”‚   â”‚
â”‚  â”‚  localhost:5000                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                    â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚          Nextflow Pipeline                          â”‚   â”‚
â”‚  â”‚  - BWA, GATK, Manta, Paraphase                      â”‚   â”‚
â”‚  â”‚  - Docker/Singularity containers                    â”‚   â”‚
â”‚  â”‚  - Micromamba í™˜ê²½ ê´€ë¦¬                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                    â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         Directory Structure                         â”‚   â”‚
â”‚  â”‚  fastq/<work_dir>/<sample>/     (ì›ë³¸)              â”‚   â”‚
â”‚  â”‚  analysis/<work_dir>/<sample>/  (intermediate)      â”‚   â”‚
â”‚  â”‚  output/<work_dir>/<sample>/    (final results)     â”‚   â”‚
â”‚  â”‚  log/<work_dir>/<sample>/       (logs)              â”‚   â”‚
â”‚  â”‚  work/                          (Nextflow temp)     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ³ Docker êµ¬ì„±

### 1. Dark Gene Pipeline (í˜„ì¬ êµ¬ì¡°)
- **íƒ€ì…**: Host ì‹œìŠ¤í…œì—ì„œ ì§ì ‘ ì‹¤í–‰
- **Docker ì‚¬ìš©**: ê° í”„ë¡œì„¸ìŠ¤ë³„ container ì‚¬ìš©
  - `quay.io/biocontainers/bwa:0.7.17`
  - `broadinstitute/gatk:4.4.0.0`
  - `quay.io/biocontainers/manta:1.6.0`
  - `quay.io/biocontainers/paraphase:3.1.0`
  - etc.
- **ì‹¤í–‰ ë°©ì‹**: Nextflowê°€ í•„ìš”ì— ë”°ë¼ Docker pull & run
- **í”„ë¡œíŒŒì¼**: `docker` ë˜ëŠ” `singularity`

### 2. Portal Daemon (ìƒˆë¡œ ì¶”ê°€)
- **íƒ€ì…**: ë…ë¦½ì ì¸ Docker container
- **Base Image**: `python:3.11-slim`
- **ì‹¤í–‰**: Docker Compose ë˜ëŠ” ë‹¨ë… ì‹¤í–‰
- **Volume Mount**: íŒŒì´í”„ë¼ì¸ ë””ë ‰í† ë¦¬ (read-only)
- **ë„¤íŠ¸ì›Œí¬**: Host ë„¤íŠ¸ì›Œí¬ ë˜ëŠ” ë¸Œë¦¬ì§€

---

## ğŸ”„ ë°ì´í„° íë¦„

### 1. ë¶„ì„ ì‹œì‘ (Dashboard â†’ Pipeline)
```
ì‚¬ìš©ì (Dashboard)
   â†“ ìƒ˜í”Œ ì„ íƒ & Start
Dashboard (Flask)
   â†“ Nextflow ì‹¤í–‰
Pipeline (Nextflow + Docker containers)
   â†“ ë¶„ì„ ìˆ˜í–‰
Results â†’ output/<work_dir>/<sample>/
   â†“ analysis.completed ìƒì„±
fastq/<work_dir>/<sample>/analysis.completed
```

### 2. ê²°ê³¼ ì—…ë¡œë“œ (Daemon â†’ Portal)
```
Daemon (File Watcher)
   â†“ analysis.completed ê°ì§€
Daemon (Scanner)
   â†“ output/ ë””ë ‰í† ë¦¬ ìŠ¤ìº”
Daemon (Uploader)
   â†“ Portal API í˜¸ì¶œ
Portal
   â†“ íŒŒì¼ ì €ì¥ & DB ê¸°ë¡
Portal Dashboard
   â†“ ì‚¬ìš©ìì—ê²Œ í‘œì‹œ
```

### 3. ìƒíƒœ ëª¨ë‹ˆí„°ë§ (Portal â† Daemon)
```
Portal (Frontend)
   â†“ GET /api/analysis/summary
Portal (Backend)
   â†“ ë‚´ë¶€ ë˜ëŠ” Daemon API í˜¸ì¶œ
Daemon API (GET /api/summary)
   â†“ ë””ë ‰í† ë¦¬ ìŠ¤ìº” & ìƒíƒœ ì§‘ê³„
Response: {
    today_requested: 0,
    running: 0,
    today_completed: 0,
    ...
}
```

---

## ğŸ“ íŒŒì¼ ì‹œìŠ¤í…œ êµ¬ì¡°

### Pipeline ê´€ì 
```
/home/ken/dark_gene_pipeline/
â”œâ”€â”€ fastq/2601/Sample_A10/
â”‚   â”œâ”€â”€ *_R1_*.fq.gz
â”‚   â”œâ”€â”€ *_R2_*.fq.gz
â”‚   â””â”€â”€ analysis.completed â† Daemon ê°ì‹œ
â”œâ”€â”€ analysis/2601/Sample_A10/
â”‚   â”œâ”€â”€ alignment/*.bam
â”‚   â”œâ”€â”€ variant/*.vcf.gz
â”‚   â””â”€â”€ pipeline_info/trace.txt â† Daemon íŒŒì‹± (ì§„í–‰ë¥ )
â”œâ”€â”€ output/2601/Sample_A10/ â† Daemon ì—…ë¡œë“œ ëŒ€ìƒ
â”‚   â”œâ”€â”€ summary/*.txt
â”‚   â”œâ”€â”€ snapshots/*.html
â”‚   â”œâ”€â”€ vcf/*.vcf.gz
â”‚   â””â”€â”€ bam/*.bam
â””â”€â”€ log/2601/Sample_A10/
    â””â”€â”€ nextflow.log
```

### Daemon ê´€ì  (Docker Volume Mount)
```
/pipeline/ (inside container)
â”œâ”€â”€ fastq/     â†’ /home/ken/.../fastq:ro
â”œâ”€â”€ analysis/  â†’ /home/ken/.../analysis:ro
â”œâ”€â”€ output/    â†’ /home/ken/.../output:ro
â””â”€â”€ log/       â†’ /home/ken/.../log:ro
```

---

## ğŸš€ ë°°í¬ ì‹œë‚˜ë¦¬ì˜¤

### ì‹œë‚˜ë¦¬ì˜¤ 1: All-in-One (í˜„ì¬ ê¶Œì¥)
```
Server A (ë¶„ì„ ì„œë²„)
â”œâ”€â”€ Dark Gene Pipeline (Host)
â”‚   â”œâ”€â”€ Nextflow
â”‚   â”œâ”€â”€ Docker containers (per process)
â”‚   â””â”€â”€ Dashboard (Flask, port 5000)
â””â”€â”€ Portal Daemon (Docker, port 8080)
    â””â”€â”€ Volume mounts â†’ Pipeline directories
```

**ì¥ì :**
- ë‹¨ì¼ ì„œë²„ ê´€ë¦¬
- íŒŒì¼ ì‹œìŠ¤í…œ ì§ì ‘ ì ‘ê·¼ (ë¹ ë¦„)
- ë„¤íŠ¸ì›Œí¬ ì§€ì—° ì—†ìŒ

**ë‹¨ì :**
- ì„œë²„ ë¦¬ì†ŒìŠ¤ ê²½í•© ê°€ëŠ¥
- í™•ì¥ì„± ì œí•œ

---

### ì‹œë‚˜ë¦¬ì˜¤ 2: ë¶„ë¦¬ ë°°í¬ (ëŒ€ê·œëª¨ í™˜ê²½)
```
Server A (ë¶„ì„ ì„œë²„)
â””â”€â”€ Dark Gene Pipeline (Host)
    â”œâ”€â”€ Nextflow
    â””â”€â”€ Dashboard (port 5000)
    
Server B (Daemon ì„œë²„)
â””â”€â”€ Portal Daemon (Docker, port 8080)
    â””â”€â”€ NFS/SMB mount â†’ Server A directories

Server C (Portal ì„œë²„)
â””â”€â”€ Portal Application
    â””â”€â”€ API calls â†’ Daemon (Server B)
```

**ì¥ì :**
- ì—­í•  ë¶„ë¦¬ (ë¶„ì„ vs ì—…ë¡œë“œ)
- í™•ì¥ ê°€ëŠ¥
- Portal ë…ë¦½ì  ìš´ì˜

**ë‹¨ì :**
- ë„¤íŠ¸ì›Œí¬ íŒŒì¼ ì‹œìŠ¤í…œ í•„ìš”
- ê´€ë¦¬ ë³µì¡ë„ ì¦ê°€

---

## ğŸ”Œ Portal API ìŠ¤í™

### Portalì´ ì œê³µí•´ì•¼ í•˜ëŠ” API

#### 1. ì£¼ë¬¸ ìƒì„±
```http
POST /api/v1/analysis/order
Authorization: Bearer {api_key}

Request:
{
    "work_dir": "2601",
    "sample_name": "Sample_A10",
    "status": "WAITING",
    "institution_id": "genolyx"
}

Response:
{
    "order_id": "ORD-2601-001",
    "status": "created"
}
```

#### 2. ìƒíƒœ ì—…ë°ì´íŠ¸
```http
PUT /api/v1/analysis/order/{order_id}
Authorization: Bearer {api_key}

Request:
{
    "status": "RUNNING",
    "progress": 45,
    "details": "CALL_VARIANTS in progress"
}

Response:
{
    "status": "updated"
}
```

#### 3. íŒŒì¼ ì—…ë¡œë“œ
```http
POST /api/v1/analysis/upload
Authorization: Bearer {api_key}
Content-Type: multipart/form-data

Form Data:
- file: (binary)
- order_id: ORD-2601-001
- file_type: summary
- file_size: 12345

Response:
{
    "file_id": "FILE-001",
    "url": "https://portal.../files/FILE-001"
}
```

#### 4. ì™„ë£Œ ë³´ê³ 
```http
POST /api/v1/analysis/order/{order_id}/complete
Authorization: Bearer {api_key}

Request:
{
    "status": "COMPLETED",
    "duration": "2h 15m",
    "completed_at": "2026-01-21T14:30:00Z"
}

Response:
{
    "status": "completed"
}
```

---

## ğŸ“Š ìƒíƒœ ë™ê¸°í™”

### Portal Summary í˜ì´ì§€ (ì²¨ë¶€ ì´ë¯¸ì§€)

**ë°ì´í„° ì†ŒìŠ¤ ì˜µì…˜:**

#### ì˜µì…˜ 1: Daemon API ì§ì ‘ í˜¸ì¶œ
```javascript
// Portal Frontend
async function updateSummary() {
    const response = await fetch('http://daemon-server:8080/api/summary');
    const data = await response.json();
    
    // UI ì—…ë°ì´íŠ¸
    document.getElementById('today-requested').textContent = data.today_requested;
    document.getElementById('running').textContent = `${data.running}/8`;
    // ...
}
```

#### ì˜µì…˜ 2: Portal DB ê¸°ë°˜ (ê¶Œì¥)
```
Daemon â†’ Portal API â†’ Portal DB
Portal Frontend â†’ Portal Backend â†’ Portal DB
```

**ì¥ì :**
- Portalì´ ë°ì´í„° ì†Œìœ 
- íˆìŠ¤í† ë¦¬ ê´€ë¦¬ ìš©ì´
- ë³µìˆ˜ Daemon ì§€ì› ê°€ëŠ¥

---

## ğŸ”§ ì„¤ì • ì˜ˆì‹œ

### 1. Daemon í™˜ê²½ ë³€ìˆ˜ (`.env`)
```bash
PORTAL_URL=https://portal.genolyx.com
PORTAL_API_KEY=pk_live_abc123xyz789
INSTITUTION_ID=genolyx
PIPELINE_BASE_DIR=/pipeline
```

### 2. Docker Compose ì‹¤í–‰
```bash
cd /home/ken/dark_gene_pipeline/daemon

# .env íŒŒì¼ ìƒì„±
cp .env.example .env
vim .env  # API Key ì„¤ì •

# ì‹¤í–‰
docker-compose up -d

# í™•ì¸
docker-compose ps
curl http://localhost:8080/api/health
```

### 3. Dashboard ì‹¤í–‰ (ë³„ë„)
```bash
cd /home/ken/dark_gene_pipeline/dashboard
python3 app.py
# http://localhost:5000
```

---

## ğŸ¯ í†µí•© í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### 1. ì „ì²´ íë¦„ í…ŒìŠ¤íŠ¸
```bash
# 1. Daemon ì‹œì‘
cd daemon && docker-compose up -d

# 2. Dashboard ì‹œì‘
cd dashboard && python3 app.py &

# 3. ìƒ˜í”Œ ë¶„ì„ ì‹œì‘ (Dashboard)
# http://localhost:5000 â†’ Select Sample â†’ Analyze

# 4. Daemon ë¡œê·¸ ëª¨ë‹ˆí„°ë§
docker-compose logs -f daemon

# 5. Daemon API í™•ì¸
curl http://localhost:8080/api/summary

# 6. Portal í™•ì¸ (ì‹¤ì œ Portal í•„ìš”)
# https://portal.genolyx.com/analysis/summary
```

### 2. ìˆ˜ë™ ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸
```bash
# ë¶„ì„ ì™„ë£Œ ë§ˆì»¤ ìƒì„± (ìˆ˜ë™)
touch /home/ken/dark_gene_pipeline/fastq/2601/Sample_Test/analysis.completed

# Daemonì´ ìë™ ê°ì§€ ë° ì—…ë¡œë“œ (ì•½ 5ì´ˆ ë‚´)
docker-compose logs -f daemon | grep "Sample_Test"
```

---

## ğŸ“ ìš”ì•½

### Dark Gene Pipeline
- âœ… Host ì‹œìŠ¤í…œì—ì„œ ì‹¤í–‰
- âœ… Nextflow + Docker containers (per process)
- âœ… Dashboard (Flask, localhost:5000)

### Portal Daemon
- âœ… **ë³„ë„ Docker container**
- âœ… ë…ë¦½ì  ì´ë¯¸ì§€ (`dark-gene-daemon:latest`)
- âœ… Pipeline ë””ë ‰í† ë¦¬ ë§ˆìš´íŠ¸ (read-only)
- âœ… Portal API í´ë¼ì´ì–¸íŠ¸
- âœ… REST API ì„œë²„ (localhost:8080)

### í†µí•© í¬ì¸íŠ¸
- âœ… File System: `analysis.completed` ë§ˆì»¤
- âœ… API: Portal REST API
- âœ… ë„¤íŠ¸ì›Œí¬: Docker bridge ë˜ëŠ” host

**ì´ì œ Portal APIë§Œ ì¤€ë¹„ë˜ë©´ ì „ì²´ ì‹œìŠ¤í…œì´ ì‘ë™í•©ë‹ˆë‹¤!** ğŸš€
